{% extends 'landing_base.html' %}
{% block content %}

<style>
      .blog-top-margin {
    margin-top: 100px;
  }
</style>

<div class="container my-5 blog-top-margin ">
  <div class="row">

    <!-- Left: Event Banner -->
    <div class="col-md-6">
      {% if event.image %}
      <img src="{{ event.image.url }}" alt="{{ event.title }}" style="max-width:100%; border-radius:8px;">
      {% endif %}
    </div>

    <!-- Right: Description + Form -->
    <div class="col-md-6">
      <h2>{{ event.title }}</h2>
      <p>{{ event.description }}</p>

     <h4 style="color:green;">Register for this Event</h4>

<div style="background-color:#f8f9fa; padding:20px; border-radius:10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom:20px;">
    
    <!-- Message & Loading -->
    <div id="registration-message" style="margin-bottom:10px;"></div>
    <div id="registration-loading" style="display:none; margin-bottom:10px;">
        <img src="https://i.imgur.com/LLF5iyg.gif" alt="Loading..." style="width:30px; vertical-align: middle; margin-right:5px;">
        Registering...
    </div>

    <form id="event-registration-form" method="POST">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" id="registration-button" class="btn btn-primary">Register</button>
    </form>

</div>

    </div>

  </div>
</div>

<!-- jQuery AJAX -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function(){
    // get CSRF token
    var csrftoken = $('input[name="csrfmiddlewaretoken"]').val();

    $('#event-registration-form').submit(function(e){
        e.preventDefault();

        var formData = $(this).serialize();

        // Show loading
        $('#registration-loading').show();
        $('#registration-message').html('');
        $('#registration-button').prop('disabled', true);

        $.ajax({
            url: "{% url 'event_detail' id=event.id %}",
            type: "POST",
            data: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrftoken
            },
            success: function(response){
                $('#registration-loading').hide();
                $('#registration-button').prop('disabled', false);

                if(response.success){
                    $('#registration-message').html(
                        '<div class="alert alert-success" style="background-color:#d4edda; color:#155724; border-radius:5px; padding:10px;">' +
                        'Thank you for enrolling in this event! We will get back to you shortly.' +
                        '</div>'
                    );
                    $('#event-registration-form')[0].reset();
                } else {
                    var errors = JSON.parse(response.errors);
                    var errorHtml = '<div class="alert alert-danger" style="background-color:#f8d7da; color:#721c24; border-radius:5px; padding:10px;"><ul>';
                    for(var field in errors){
                        for(var i in errors[field]){
                            errorHtml += '<li>' + errors[field][i].message + '</li>';
                        }
                    }
                    errorHtml += '</ul></div>';
                    $('#registration-message').html(errorHtml);
                }
            },
            error: function(xhr){
                $('#registration-loading').hide();
                $('#registration-button').prop('disabled', false);

                let msg = 'Something went wrong. Please try again.';
                if(xhr.responseJSON && xhr.responseJSON.errors){
                    msg = xhr.responseJSON.errors;
                }
                $('#registration-message').html(
                    '<div class="alert alert-danger" style="background-color:#f8d7da; color:#721c24; border-radius:5px; padding:10px;">' + msg + '</div>'
                );
            }
        });
    });
});
</script>

{% endblock %}
